---
title: "cell-cell-Group6"
format: html
---

# Cell-Cell Communication Analysis

```{r}
suppressPackageStartupMessages({
library(CellChat)
library(patchwork)
})
options(stringsAsFactors = FALSE)
```

#### a. Create a CellChat object from our Seurat object and set *CellChatDB.human* as the ligand-receptor interaction database for the analysis.

```{r}
#Create a CellChat object
cellchat <- createCellChat(object = pbmc.MTB, meta = pbmc.MTB@meta.data, group.by = "cell_type_manual")
```

```{r}
CellChatDB <- CellChatDB.human 
showDatabaseCategory(CellChatDB)
```

#### b. Subset the interaction-ligatand database to include only “Secreted Signaling” and set it as the database for cellchat.

```{r}
# Show the structure of the database
dplyr::glimpse(CellChatDB$interaction)
```

```{r}
# CellChatDB.use <- subsetDB(CellChatDB, search = "Secreted Signaling") # use Secreted Signaling
# showDatabaseCategory(CellChatDB.use)
# cellchat@DB <- CellChatDB.use
```

#### c. Pre-process the expression data for cell-cell communication analysis

```{r}
# subset the expression data of signaling genes for saving computation cost
cellchat <- subsetData(cellchat) # This step is necessary if using the whole database
future::plan("multisession", workers = 4) # do parallel
cellchat <- identifyOverExpressedGenes(cellchat)
cellchat <- identifyOverExpressedInteractions(cellchat)
```

#### d. Infer the cell-cell communication network.

```{r}
cellchat <- computeCommunProb(cellchat)
```

```{r}
 # Filter out the cell-cell communication if there are only few number of cells in certain cell groups
cellchat <- filterCommunication(cellchat, min.cells = 10)

#Extract the inferred cellular communication network as a data frame
df.net <- subsetCommunication(cellchat) #returns a data frame consisting of all the inferred cell-cell communications at the level of ligands/receptors. 

#Infer the cell-cell communication at a signaling pathway level
cellchat <- computeCommunProbPathway(cellchat)
```

#### e. Calculate the aggregated cell-cell communication network and do the visualization.

```{r}
#Calculate the aggregated cell-cell communication network
cellchat <- aggregateNet(cellchat)
groupSize <- as.numeric(table(cellchat@idents))
par(mfrow = c(1,2), xpd=TRUE)
netVisual_circle(cellchat@net$count, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "Number of interactions")
netVisual_circle(cellchat@net$weight, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "Interaction weights/strength")
```

#### f. Visualize TNF signaling pathway with `netVisual_aggregate` and `netVisual_heatmap`. See [Visualization of cell-cell communication at different levels](https://htmlpreview.github.io/?https://github.com/jinworks/CellChat/blob/master/tutorial/CellChat-vignette.html#visualize-each-signaling-pathway-using-hierarchy-plot-circle-plot-or-chord-diagram).

```{r}
pathways <- cellchat@netP$pathways

pathways.show <- c("TNF") 

# Circle plot
par(mfrow=c(1,1))
netVisual_aggregate(cellchat, signaling = pathways.show, layout = "circle")
```

```{r}
# Heatmap
par(mfrow=c(1,1))
netVisual_heatmap(cellchat, signaling = pathways.show, color.heatmap = "Reds")
```
